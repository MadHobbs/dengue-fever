---
title: "Data Exlporation"
author: "Jenn Havens and Madison Hobbs"
date: "November 8, 2017"
output: pdf_document
---

```{r loadData, echo = F , warning=FALSE, include=FALSE}

require(dplyr)
require(ggplot2)

TestPred <- read.csv("./DengAI_Predicting_Disease_Spread_-_Test_Data_Features.csv")

TrainPred <- read.csv("./DengAI_Predicting_Disease_Spread_-_Training_Data_Features.csv")
TrainResp <- read.csv("./DengAI_Predicting_Disease_Spread_-_Training_Data_Labels.csv")

TrainFull <- full_join(TrainResp, TrainPred, by = c("city", "year", "weekofyear"))

require(rpart)
require(caret)
require(tidyverse)
require(ggcorrplot)
```

# Variable Selection

## Temperature

We think that the station-measured temperature would be preferable, because these are not measured from satellite or estimated from a model. 

We should also think about whether to choose minimum temperature, maximum temperature, average temperature, or diurnal temperature range. We suspect that these variables are redundant, and we can clearly see from the data below:

```{r}
temps <- TrainFull %>% select(station_max_temp_c,station_avg_temp_c, station_min_temp_c, station_diur_temp_rng_c)

corr_matrix <- cor(temps)
corr_pmat <- cor_pmat(temps)
# they are all significantly correlated 
all(corr_pmat < 0.05)
```

All pairwise correlations betweent the four measures of temperature are significant. We can see these strong correlations represented in the correlation plot below:

```{r}
ggcorrplot(corr_matrix, hc.order = TRUE)
```

Note that Choi et. al say : "Mean temperature was significantly associated with dengue incidence in all three provinces, but incidence did not correlate well with maximum temperature in Banteay Meanchey, nor with minimum temperature in Kampong Thom at a lag of three months in the negative binomial model." We are inclined to only use mean temperature. 

However, we want to first assure that there are no missing values in the station data before using it (as opposed to the satellite or model-generated data). After initial data exploration and reading, week of year is one of the most important variables for predicting dengue cases, so we don't want to leave out any weeks if possible. 

```{r}
sum(is.na(TrainFull$station_avg_temp_c))
sum(is.na(TrainFull$reanalysis_air_temp_k))

length(TrainFull$station_avg_temp_c) - sum(is.na(TrainFull$station_avg_temp_c))

cor(na.omit(TrainFull$station_avg_temp_c), (sample(na.omit(TrainFull$reanalysis_air_temp_k), 1413)))

plot(na.omit(TrainFull$station_avg_temp_c))
plot((na.omit(TrainFull$reanalysis_air_temp_k) - 273.15))
```


## Precipitation

Similarly, it makes sense to use station-measured precipitation as opposed to satellite or model-produced precipitation measurements. However, we need to have no missing values. 

```{r}
sum(is.na(TrainFull$station_precip_mm))
sum(is.na(TrainFull$precipitation_amt_mm))
sum(is.na(TrainFull$reanalysis_sat_precip_amt_mm))
sum(is.na(TrainFull$precipitation_amt_mm))
```


Variable descriptions https://www.drivendata.org/competitions/44/dengai-predicting-disease-spread/page/82/. 

Week and week of year provide the same information, so we'll keep only week inside the model. 

There are three measures of precipitation. One is station_precip_mm which is the total daily precipitation as measured by NOAA's GHCN weather stations (https://www.ncdc.noaa.gov/ghcn-daily-description). Another is precipitation_amt_mm which represents total precipitation as measured by PERSIANN satellites. The third and forth, reanalysis_sat_precip_amt_mm and reanalysis_precip_amt_kg_per_m2 are both generated by NOAA's NCEP Climate Forecast System Reanalysis (https://climatedataguide.ucar.edu/climate-data/climate-forecast-system-reanalysis-cfsr). 

We should choose one of these precipitation  measures for the model, since these four precipitation measures all measure approximately the same thing. We decide on the daily precipitation as measured by NOAA's GHCN (https://www.ncdc.noaa.gov/ghcn-daily-description) because it represents actually recorded daily measurements, not satellite or model estimates. It is as close to the source as we can get. 
Same thing for minimum temperature, maximum temperature, average temperature, and diurnal temperature. 


```{r}
data_for_model <- TrainFull %>% select(city, year, weekofyear, total_cases, station_precip_mm, station_avg_temp_c)
```


### Which Air Temperature Measures Should Be Included?

Note that Choi et. al say : "Mean temperature was significantly associated with dengue incidence in all three provinces, but incidence did not correlate well with maximum temperature in Banteay Meanchey, nor with minimum temperature in Kampong Thom at a lag of three months in the negative binomial model." I'm inclined to only use mean temperature. 

```{r}
temps <- TrainFull %>% select(station_max_temp_c,station_avg_temp_c, station_min_temp_c, station_diur_temp_rng_c)

corr_matrix <- cor(temps)
corr_pmat <- cor_pmat(temps)
# they are all significantly correlated 
corr_pmat < 0.05

ggcorrplot(corr_matrix, hc.order = TRUE)
```

```{r}
temps <- TrainFull %>% select(station_avg_temp_c, station_min_temp_c, station_diur_temp_rng_c)

corr_matrix <- cor(temps)
corr_pmat <- cor_pmat(temps)
# they are all significantly correlated 
corr_pmat < 0.05

ggcorrplot(corr_matrix, hc.order = TRUE)
```


### Should humidity and Dewpoint be included?

There are a series of variables generated by the Climate Forecast System Reanalysis on a 0.5 by 0.5 degree scale. The estimate precipitation, dew point, air temperature (actual, max, min, avg), relative and specific humidity, and diurnal temperature range. 

### Creating time lag variabes

They found significant association between three month lag and prediciting dengue cases. So we'll move by the 12 weeks before each observation. 

1) Precipitation

```{r}
precip_lag <- c()

sj_precip <- data_for_model %>% filter(city == "sj") %>% select(station_precip_mm)
sj_precip <- sj_precip$station_precip_mm

index = 12
while(index < length(sj_precip)) {
  precip_lag <- c(precip_lag, mean(sj_precip[index-11:index]))
  index <- index + 1
}

precip_lag <- c(mean(sj_precip[1:11]), precip_lag)
precip_lag <- c(mean(sj_precip[1:10]), precip_lag)
precip_lag <- c(mean(sj_precip[1:9]), precip_lag)
precip_lag <- c(mean(sj_precip[1:8]), precip_lag)
precip_lag <- c(mean(sj_precip[1:7]), precip_lag)
precip_lag <- c(mean(sj_precip[1:6]), precip_lag)
precip_lag <- c(mean(sj_precip[1:5]), precip_lag)
precip_lag <- c(mean(sj_precip[1:4]), precip_lag)
precip_lag <- c(mean(sj_precip[1:3]), precip_lag)
precip_lag <- c(mean(sj_precip[1:2]), precip_lag)
precip_lag <- c(mean(sj_precip[1]), precip_lag)
precip_lag <- c(mean(sj_precip[1]), precip_lag)

sj_data_for_model <- data_for_model %>% filter(city == "sj") %>% mutate(precip_lag = precip_lag)
```


```{r}
iq_precip_lag <- c()

iq_precip <- data_for_model %>% filter(city == "iq") %>% select(station_precip_mm)
iq_precip <- iq_precip$station_precip_mm

index = 12
while(index < length(iq_precip)) {
  iq_precip_lag <- c(iq_precip_lag, mean(iq_precip[index-11:index]))
  index <- index + 1
}

iq_precip_lag <- c(mean(iq_precip[1:11]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:10]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:9]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:8]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:7]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:6]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:5]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:4]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:3]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1:2]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1]), iq_precip_lag)
iq_precip_lag <- c(mean(iq_precip[1]), iq_precip_lag)

iq_data_for_model <- data_for_model %>% filter(city == "iq") %>% mutate(precip_lag = iq_precip_lag)
```


## Missing Values


## Building a Model

The Driven Data team uses Mean Absolute Error to measure error, so we will, too.

```{r}
# returns Mean Absolute Error
# error is defined as actual - predicted
MAE <- function(error)
{
    mean(abs(error))
}

# returns Root Mean Squared Error
# error is defined as actual - predicted
RMSE <- function(error)
{
  sqrt(mean(error^2))
}
```


```{r}


# we should remove the san juan data for which we don't have true precip or temp lag
sj_data_for_model <- sj_data_for_model %>% slice(13:n())

# get out test set
set.seed(48)
sj_test <- sample_n(sj_data_for_model, 71)
sj_train <- anti_join(sj_data_for_model, sj_test)

sj_rf_train <- train(total_cases ~ ., data = sj_train, method = "rf", trControl = trainControl(method = "oob"), ntree = 500, tuneGrid = data.frame(mtry = 1:6), importance = TRUE)

sj_rf_train

varImp(sj_rf_train)

preds <- predict(sj_rf_train, sj_test)
MAE(sj_test$total_cases - preds)
RMSE(sj_test$total_cases - preds)
```

For a random forest with only city, year, week of year, station_precip_mm, and station_avg_temp_c, and precip_lag we get MAE =10.2 and RMSE = 18.9. 


```{r somePlots , echo = F , warning=FALSE}

enviroPredNames <- colnames(TrainFull)[6:25]



ggplot(data = TrainFull) + geom_point(aes(x=precipitation_amt_mm, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_air_temp_k, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_precip_amt_kg_per_m2, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_tdtr_k, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=station_avg_temp_c, y=total_cases)) + facet_grid(city~.)


ggplot(data = TrainFull) + geom_point(aes(x=station_precip_mm, y=total_cases)) + facet_grid(city~.)


```

```{r seasonalAnalysis , echo = F, warning=FALSE}

#there are 13 weeks in a season

findSeason <- function(week){
  if (week < 10){
    return(1)
  } else if (week < 20){
    return(2)
  } else if (week < 31){
    return(3)
  } else {
    return(4)
  }
}


TrainFullTest <- TrainFull


season <- c()
for (i in 1:length(TrainFullTest$weekofyear)){
  season <- c(season, findSeason(TrainFullTest$weekofyear[i]))
}
TrainFullTest <- cbind(TrainFullTest, season)

ggplot(data = TrainFullTest) + geom_point(aes(x=season, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFullTest) + geom_point(aes(x=weekofyear, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFullTest) + geom_point(aes(x=week_start_date, y=total_cases)) + facet_grid(city~.)


```