---
title: "Data Exlporation"
author: "Jenn Havens and Madison Hobbs"
date: "November 8, 2017"
output: pdf_document
---

```{r loadData, echo = F , warning=FALSE}

require(dplyr)
require(ggplot2)

TestPred <- read.csv("./DengAI_Predicting_Disease_Spread_-_Test_Data_Features.csv")

TrainPred <- read.csv("./DengAI_Predicting_Disease_Spread_-_Training_Data_Features.csv")
TrainResp <- read.csv("./DengAI_Predicting_Disease_Spread_-_Training_Data_Labels.csv")

TrainFull <- full_join(TrainResp, TrainPred, by = c("city", "year", "weekofyear"))

TrainFull <- TrainFull %>% na.omit()

require(rpart)
require(caret)
require(tidyverse)
require(ggcorrplot)
```

# Variable Selection

Variable descriptions https://www.drivendata.org/competitions/44/dengai-predicting-disease-spread/page/82/. 

Week and week of year provide the same information, so we'll keep only week inside the model. 

There are three measures of precipitation. One is station_precip_mm which is the total daily precipitation as measured by NOAA's GHCN weather stations (https://www.ncdc.noaa.gov/ghcn-daily-description). Another is precipitation_amt_mm which represents total precipitation as measured by PERSIANN satellites. The third and forth, reanalysis_sat_precip_amt_mm and reanalysis_precip_amt_kg_per_m2 are both generated by NOAA's NCEP Climate Forecast System Reanalysis (https://climatedataguide.ucar.edu/climate-data/climate-forecast-system-reanalysis-cfsr). 

We should choose one of these precipitation  measures for the model, since these four precipitation measures all measure approximately the same thing. We decide on the daily precipitation as measured by NOAA's GHCN (https://www.ncdc.noaa.gov/ghcn-daily-description) because it represents actually recorded daily measurements, not satellite or model estimates. It is as close to the source as we can get. 

Same thing for minimum temperature, maximum temperature, average temperature, and diurnal temperature. 

```{r}
data_for_model <- TrainFull %>% select(city, year, weekofyear, total_cases, station_precip_mm, station_avg_temp_c)
```


### Which Air Temperature Measures Should Be Included?

Note that Choi et. al say : "Mean temperature was significantly associated with dengue incidence in all three provinces, but incidence did not correlate well with maximum temperature in Banteay Meanchey, nor with minimum temperature in Kampong Thom at a lag of three months in the negative binomial model." I'm inclined to only use mean temperature. 

```{r}
temps <- TrainFull %>% select(station_max_temp_c,station_avg_temp_c, station_min_temp_c, station_diur_temp_rng_c)

corr_matrix <- cor(temps)
corr_pmat <- cor_pmat(temps)
# they are all significantly correlated 
corr_pmat < 0.05

ggcorrplot(corr_matrix, hc.order = TRUE)
```

### Should humidity and Dewpoint be included

There are a series of variables generated by the Climate Forecast System Reanalysis on a 0.5 by 0.5 degree scale. The estimate precipitation, dew point, air temperature (actual, max, min, avg), relative and specific humidity, and diurnal temperature range. 

### Creating time lag variabes

They found significant association between three month lag and prediciting dengue cases. So we'll move by the 12 weeks before each observation. 

1) Precipitation

```{r}
precip_lag <- c()

sj_precip <- data_for_model %>% filter(city == "sj") %>% select(station_precip_mm)

index = 1
while(index < length(data_for_model$station_precip_mm) - 12) {
  index <- index + 1
}

```




```{r}
sd(TrainFull$total_cases)

dengue.rf.train <- train(total_cases ~ ., data = data_for_model, method = "rf", trControl = trainControl(method = "oob"), ntree = 100, tuneGrid = data.frame(mtry = 1:24), importance = TRUE)

varImpPlot(dengue.rf.train$finalModel)
```




```{r somePlots , echo = F , warning=FALSE}

enviroPredNames <- colnames(TrainFull)[6:25]



ggplot(data = TrainFull) + geom_point(aes(x=precipitation_amt_mm, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_air_temp_k, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_precip_amt_kg_per_m2, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=reanalysis_tdtr_k, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFull) + geom_point(aes(x=station_avg_temp_c, y=total_cases)) + facet_grid(city~.)


ggplot(data = TrainFull) + geom_point(aes(x=station_precip_mm, y=total_cases)) + facet_grid(city~.)


```

```{r seasonalAnalysis , echo = F, warning=FALSE}

#there are 13 weeks in a season

findSeason <- function(week){
  if (week < 10){
    return(1)
  } else if (week < 20){
    return(2)
  } else if (week < 31){
    return(3)
  } else {
    return(4)
  }
}


TrainFullTest <- TrainFull


season <- c()
for (i in 1:length(TrainFullTest$weekofyear)){
  season <- c(season, findSeason(TrainFullTest$weekofyear[i]))
}
TrainFullTest <- cbind(TrainFullTest, season)

ggplot(data = TrainFullTest) + geom_point(aes(x=season, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFullTest) + geom_point(aes(x=weekofyear, y=total_cases)) + facet_grid(city~.)

ggplot(data = TrainFullTest) + geom_point(aes(x=week_start_date, y=total_cases)) + facet_grid(city~.)


```